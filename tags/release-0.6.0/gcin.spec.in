%define release liu_mdk
%define prefix  /usr
%define name	gcin
%define version __gcin_version__


Summary:	gcin :  big5 chinese input method server
Name:		%{name}
Version:	%{version}
Release:	%{release}
License: 	LGPL
Vendor:		Edward Liu
URL: 		http://gcin.sf.net
Group: 		Applications/System
Source0:	%{name}-%{version}.tar.bz2
Packager:       Edward Liu <cp76@csie.nctu.edu.tw>
BuildRoot:	%{_builddir}/%{name}-%{version}-root

BuildRequires: libgtk+2.0_0-devel >= 2.2.4
Requires: gtk+2.0 >= 2.2.4

Docdir:         %{prefix}/share/doc

%description
gcin is a Chinese input method server for big5 traditional Chinese. It features
a better GTK user interface.

%prep
%setup

%build

%configure
make

%install
rm -rf $RPM_BUILD_ROOT
%makeinstall

%clean
rm -rf $RPM_BUILD_ROOT


%files
%defattr(-,root,root,0755)
%doc README
%{_bindir}/*
%{_includedir}/*
%{_datadir}/gcin/*
%{_datadir}/icons/*
%{_libdir}/menu/*
%{_libdir}/gtk-2.0/*
%{_libdir}/lib*

%post
xinitdir=/etc/X11/xinit
ximorig=XIM.orig.gcin
if  [ -d $xinitdir ]; then
  cd $xinitdir
  if [ -f XIM ]; then
    if [ ! -f $ximorig ]; then
      mv XIM $ximorig
    fi
    sed -e "s/XIM_PROGRAM=xcin/XIM_PROGRAM=gcin/" < $ximorig > XIM
    chmod 755 XIM
  # RH9, contributed by xacid.bbs@wretch.twbbs.org
  elif [ -f xinitrc.d/xinput ]; then
    cd xinitrc.d
    if [ ! -f xinput.orig.gcin ]; then
      mv xinput xinput.orig.gcin
    fi
    sed -e "s/XIM_PROGRAM=xcin/XIM_PROGRAM=gcin/" < xinput.orig.gcin > \
      xinput
    chmod 755 xinput
  #SuSE 9.1 This is a testing, contributed by swyear@bbs.openfind.com.tw
  elif [ -f ../xim ]; then
    cd ..
    if [ ! -f xim.orig.gcin ]; then
      mv xim xim.orig.gcin
    fi
    declare -i TWline=`grep -n 'zh_TW\*)' xim.orig.gcin | cut -b 1-2`
    declare -i CNline=`grep -n 'zh_CN\*)' xim.orig.gcin | cut -b 1-2`
    declare -i dellineb=$TWline+1
    declare -i dellinee=$CNline-2
    sed ''$dellineb','$dellinee' d' < xim.orig.gcin > xim10
    sed ''$TWline' a \ export XMODIFIERS="@im=gcin"' < xim10 > xim11
    sed ''$dellineb' a \ gcin &' < xim11 >xim
    rm -f xim1*
    chmod 755 xim
  # others
  else
    echo "Please modify your XIM settings manually"
  fi
else
  echo "Directory $xinitdir does not exist"
fi
cd /etc/sysconfig
## below is for Mandrake 10.1
grep -i scim i18n >& /dev/null
if [ $? = 0 ]; then
  if [ ! -f i18n.orig.gcin ]; then
    mv i18n i18n.orig.gcin
  fi

  sed -e "s/im=SCIM/im=xcin/" < i18n.orig.gcin |
  sed -e "s/scim -d/gcin/" | \
  sed -e "s/MODULE=scim/MODULE=xim/" > i18n
fi

#add GTK_IM_MODULE=gcin if necessary
egrep '^GTK_IM_MODULE=gcin' i18n >& /dev/null
if [ $? != 0 ]; then
  echo -e "\nGTK_IM_MODULE=gcin" >> i18n
fi

cd /usr/X11R6/bin
grep -i scim crxvt >& /dev/null
if [ $? = 0 ]; then
  if [ ! -f crxvt.orig.cin ]; then
    mv crxvt crxvt.orig.cin
  fi

  sed -e "s/XIM=SCIM/#XIM=xim/" < crxvt.orig.cin > crxvt
  chmod 755 crxvt
fi
# install gtk IM module
cd /etc/gtk-2.0; gtk-query-immodules-2.0 > gtk.immodules.lib
cp gtk.immodules.lib gtk.immodules

ldconfig
%update_menus

%postun
xinitdir=/etc/X11/xinit
ximorig=XIM.orig.gcin
cd /etc/X11/xinit
#if [ -f XIM.orig.gcin ]; then
#  mv XIM.orig.gcin XIM
#elif [ -f xinitrc.d/xinput ]; then
# cd xinitrc.d
# if [ ! -f xinput.orig.gcin ]; then
#    mv xinput.orig.gcin xinput
# fi
#else
# echo "Please restore your XIM settings manually"
#fi
%clean_menus

%changelog

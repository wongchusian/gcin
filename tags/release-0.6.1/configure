#!/bin/bash

MAKE=make
which gmake >& /dev/null
if [ $? = 0 ]; then
  MAKE=gmake
fi


prefix="/usr/local"

for opt do
  case "$opt" in
  --prefix=*) prefix=`echo $opt | cut -d '=' -f 2`
  ;;
  esac
done

echo "prefix: $prefix"


GTK=gtk+-2.0

echo -n ".... Testing $GTK : "

GTKINC=`pkg-config --cflags $GTK`

if [ $? != 0 ]; then
  echo "$GTK or above required --cflags"
  rm -f config.mak
  exit -1;
fi

GTKLDFLAGS=`pkg-config --libs $GTK`

if [ $? != 0 ]; then
  echo "$GTK or above required --libs"
  rm -f config.mak
  exit -1;
else
  echo " found."
fi

bindir=$prefix/bin
datadir=$prefix/share
libdir=$prefix/lib
includedir=$prefix/include
GCIN_VERSION=`cat VERSION.gcin`
sed -e "s/__gcin_version__/$GCIN_VERSION/" < gcin.spec.in > gcin.spec

OPTFLAGS="-g"
if [ $prefix = /usr ]; then
  OPTFLAGS="-O"
fi

echo "CC=gcc" > config.mak
echo "MAKE=$MAKE" >> config.mak
echo "GTKINC=$GTKINC" >> config.mak
echo "prefix=$prefix" >> config.mak
echo "bindir=\$(DESTDIR)$bindir" >> config.mak
echo "bindir_r=$bindir" >> config.mak
echo "datadir=\$(DESTDIR)$datadir" >> config.mak
echo "datadir_r=$datadir" >> config.mak
echo "libdir=\$(DESTDIR)$libdir" >> config.mak
echo "includedir=\$(DESTDIR)$includedir" >> config.mak

echo "LDFLAGS=$GTKLDFLAGS" >> config.mak
echo "GCIN_VERSION=$GCIN_VERSION" >> config.mak
echo "GCIN_TABLE_DIR=\$(datadir_r)/gcin/table" >> config.mak
echo "GCIN_TABLE_DIR_i=\$(datadir)/gcin/table" >> config.mak
echo "GCIN_SCRIPT_DIR=\$(datadir_r)/gcin/script" >> config.mak
echo "GCIN_SCRIPT_DIR_i=\$(datadir)/gcin/script" >> config.mak
echo "OPTFLAGS=$OPTFLAGS" >> config.mak
echo "DOC_DIR=\$(datadir_r)/doc/gcin-$GCIN_VERSION" >> config.mak
echo "GCIN_ICON_DIR=\$(datadir_r)/icons/gcin" >> config.mak
echo "GCIN_ICON_DIR_i=\$(datadir)/icons/gcin" >> config.mak
echo "GCIN_BIN_DIR=\$(bindir_r)" >> config.mak

cd menu
for i in *.in
do
  outf=`echo $i | sed -e "s/\.in//"`
  echo $outf
  if [ $bindir = /usr/bin ]; then
    sed -e "s~/usr/local/bin~/usr/bin~" < $i > $outf
  else
    cp $i $outf
  fi
done
